---
title: "Analysis of negative control conditions in previous publications using the distress induction procedure cited in Foody et al. (2012)"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

Anxiety VAS scales only, and negative control conditions only (i.e., no instructions on how people can remove distress)

```{r, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

# Dependencies and functions

```{r}

# dependencies

library(tidyverse)
library(knitr)
library(kableExtra)
library(janitor)
library(forcats)
library(patchwork)
library(ggstance)

# disable scientific notation
options(scipen=999)

# create director
dir.create("plots/")
dir.create("tables/")


#' apa_p_value
#'
#' This function uses rounds p values using APA rules: No leading zero, rounded to three decimal places (via ceiling rather than round), below this shows as "< .001".
#' @param p p value to be formatted
#' @export
#' @examples
#' apa_p_value(0.00000004)
#' apa_p_value(0.487173)
apa_p_value <- function(p, digits = 4){
  p_formatted <- ifelse(p >= 10^-digits, 
                        as.character(ceiling(as.numeric(p)*10^digits)/10^digits),
                        paste0("< .", paste0(rep.int(0, times = digits-1), collapse = ""), "1"))
  p_formatted <- gsub(pattern = "0.", replacement = ".", x = p_formatted, fixed = TRUE)
  p_formatted
}


#' Calculate an independent t test from summary statistics
#' @source https://stats.stackexchange.com/q/30450. Improvements made to readability and documentation, added effect sizes.
#' @param m1: the sample 1 mean
#' @param m2: the sample 2 mean
#' @param sd1: the sample 1 SD
#' @param sd2: the sample 2 SD
#' @param n1: the sample 2 sample size
#' @param n2: the sample 2 sample size
#' @param m0: the null value for the difference in means to be tested for. Default is 0. 
#' @param equal.variance: whether or not to assume equal variance. Default is FALSE as in the base R t.test function, i.e., a Welch's t-test. Setting to TRUE will produce a Student's t-test.
t_test_from_descriptives <- function(m1, m2, sd1, sd2, n1, n2, m0 = 0, equal.variance = FALSE) {
  require(psych)
  
  if(equal.variance == FALSE) {
    se <- sqrt( (sd1^2/n1) + (sd2^2/n2) )
    # welch-satterthwaite df
    df <- ( (sd1^2/n1 + sd2^2/n2)^2 )/( (sd1^2/n1)^2/(n1-1) + (sd2^2/n2)^2/(n2-1) )
  } else {
    # pooled standard deviation, scaled by the sample sizes
    se <- sqrt( (1/n1 + 1/n2) * ((n1-1)*sd1^2 + (n2-1)*sd2^2)/(n1+n2-2) ) 
    df <- n1+n2-2
  } 
  
  t <- (m1 - m2 - m0)/se 
  d <- (m1 - m2) / sqrt((sd1^2 + sd2^2)/2)
  d_cis <- psych::cohen.d.ci(d, n2 = n2, n1 = n1, alpha = .05)
  
  g <- d * ( 1 - (3 / ((4*(n1 + n2 - 2)) - 1)) ) # https://stats.stackexchange.com/q/434978 by Wolfgang Vichtbauer, creator of metafor package
  g_cis <- psych::cohen.d.ci(g, n2 = n2, n1 = n1, alpha = .05)
  
  dat <- data.frame(m1 = m1, 
                    sd1 = sd1, 
                    n1 = n1, 
                    m2 = m2, 
                    sd2 = sd2, 
                    n2 = n2,
                    mean_difference = m1 - m2,
                    se = se,
                    cohens_d = d,
                    cohens_d_ci_lower = d_cis[1],
                    cohens_d_ci_upper = d_cis[3],
                    hedges_g = g,
                    hedges_g_ci_lower = g_cis[1],
                    hedges_g_ci_upper = g_cis[3],
                    t = t, 
                    df = df,
                    p = 2 * pt(-abs(t), df))
  
  return(dat) 
}

round_all_but_p_values <- function(output, digits = 2){
  require(dplyr)
  
  output |>
    mutate(p = as.character(p)) |>
    mutate_if(is.numeric, janitor::round_half_up, digits = 2)
}

```

# Data

Anxiety VAS ratings taken from previous publications using the single sentence distress induction task cited in Foody et al. 2012. Anxiety only, as it's the only common outcome that is shared between Foody, Rachman and other papers. No instructions only condition, in order to quantify negative control conditions.

- Rachman et al. (1996): Data included below.
- Van den Hout et al (2002): Data included below.
- Zucker et al. (2002): Did include a control condition but not include a post delay timepoint. Available data included below.
- Bocci & Gordon (2007): Did not include a strictly no instructions condition. Participants were instructed they could do anything they like, including to the paper (i.e., what Rachman et al. would call neutralisation). Data included below, but this condition is not precisely the same as those 
- Marcks & Woods (2007): Included a no instructions "monitor only" condition but report that they dropped it from their analysis, only reporting scores at one timepoint. No data included below.

```{r}

# Taken from Table 1 for "Condition 2 Delay-neutralization", which received no instructions between postinduction and postdelay. Delay was a 20 minute follow up. Data came from a single item 0-100 VAS scale measuring current anxiety, as in Foody's work.
dat_rachman <- 
  tibble(timepoint = c("Baseline", "Postinduction", "Postdelay"),
         m = c(12.2, 69.7, 15.29),
         sd = c(9.3, 14.4, 18.5),
         n = c(34, 34, 34),
         se = sd / sqrt(n)) |>
  mutate(timepoint = fct_relevel(timepoint, c("Baseline", "Postinduction", "Postdelay")),
         study = "Rachman et al. (1996)", 
         included_no_instructions_condition = TRUE)

# Taken from Table 2 no instruction groups. 
# nb postinduction = "post imaging", postdelay = "After 2 mins" in table
dat_vandenhout <- 
  tibble(timepoint = c("Baseline", "Postinduction", "Postdelay"), 
         m = c(6, 35, 10),
         sd = c(7, 27, 13),
         n = c(40, 40, 40),
         se = sd / sqrt(n)) |>
  mutate(timepoint = fct_relevel(timepoint, c("Baseline", "Postinduction", "Postdelay")),
         study = "van den Hout et al. (2002)", 
         included_no_instructions_condition = TRUE)

dat_zucker <- 
  tibble(timepoint = c("Baseline", "Postinduction", "Postdelay"), 
         m = c(34.28, 61.28, NA),
         sd = c(27.99, 18.18, NA),
         n = c(36, 36, NA),
         se = sd / sqrt(n)) |>
  mutate(timepoint = fct_relevel(timepoint, c("Baseline", "Postinduction", "Postdelay")),
         study = "Zucker et al. (2002)", 
         included_no_instructions_condition = FALSE)

dat_bocci <- 
  tibble(timepoint = c("Baseline", "Postinduction", "Postdelay"), 
         m = c(24.06, 59.71, 43.61),
         sd = c(20.43, 20.68, 17.81),
         n = c(49, 49, 49),
         se = sd / sqrt(n)) |>
  mutate(timepoint = fct_relevel(timepoint, c("Baseline", "Postinduction", "Postdelay")),
         study = "Bocci & Gordon (2007)", 
         included_no_instructions_condition = FALSE)

dat <- 
  bind_rows(dat_rachman, 
            dat_vandenhout,
            dat_zucker,
            dat_bocci) |>
  mutate(study = fct_relevel(study, "Rachman et al. (1996)", "van den Hout et al. (2002)", "Zucker et al. (2002)", "Bocci & Gordon (2007)"))

```

```{r}

data_foodyetal2013 <- read_csv("../../foody et al 2013 publication/analysis/tables/change baseline to postinduction.csv")
data_foodythesisexp10 <- read_csv("../../foody 2013 thesis experiment 10/analysis/tables/change baseline to postinduction.csv")

```

# Comparing baseline to post intervention

## Table descriptive statistics

Extracted from original articles

```{r}

dat_descriptives_all <- dat |>
  select(study, timepoint, m, sd, n, included_no_instructions_condition) 

dat_descriptives_all |>
  kable() |>
  kable_classic(full_width = FALSE)

write_csv(dat_descriptives_all, "tables/descriptive statistics.csv")

```

## Plot means

Intervals are 95% CIs calculated from the SEs, which were calculated from the N and SDs.

```{r fig.height=4, fig.width=5}

p1 <-
  ggplot(dat, aes(timepoint, m, color = study, group = study)) +
  geom_line(alpha = 0.5,
            position = position_dodge(width = 0.2)) +
  geom_linerange(aes(ymin = m - se*1.96, ymax = m + se*1.96), position = position_dodge(width = 0.2)) +
  geom_point(position = position_dodge(width = 0.2)) +
  scale_color_viridis_d(option = "mako", begin = 0.3, end = 0.7,
                        name = "Study") +
  ylim(0,100) +
  theme_linedraw() +
  ylab("Anxiety VAS") +
  xlab("Time point") +
  theme(legend.position = c(.75, .75),
        legend.background = element_rect(fill='transparent'),
        legend.box.background = element_rect(fill='white'))

p1

# ggplot2::ggsave(filename = "plots/baseline to postinduction means.pdf",
#                 plot     = p1,
#                 device   = "pdf",
#                 width    = 5,
#                 height   = 4,
#                 units    = "in")

```

## Table effect sizes

Positive values represent less anxiety.

```{r fig.height=2, fig.width=5}

data_es_induction <-
  dat |>
  pivot_wider(names_from = timepoint,
              values_from = c(m, sd, n, se)) |>
  group_by(study) |>
  do(t_test_from_descriptives(m1 = .$m_Baseline, 
                              m2 = .$m_Postinduction, 
                              sd1 = .$sd_Baseline, 
                              sd2 = .$sd_Postinduction, 
                              n1 = .$n_Baseline, 
                              n2 = .$n_Postinduction)) |>
  ungroup() |>
  mutate(comparison = "Baseline vs postinduction") |>
  select(study, comparison, hedges_g, lower = hedges_g_ci_lower, upper = hedges_g_ci_upper, 
         t, df, p) |>
  mutate(p = apa_p_value(p, digits = 5)) |>
  arrange(study) |>
  round_all_but_p_values()

data_es_induction |>
  kable() |>
  kable_classic(full_width = FALSE)

write_csv(data_es_induction, "tables/effect sizes baseline vs postinduction.csv")

```

## Plot effect sizes

```{r fig.height=2, fig.width=5}

p2 <- 
  ggplot(data_es_induction, aes(fct_rev(study), hedges_g)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_point(shape = "square") +
  geom_linerange(aes(ymin = lower, ymax = upper)) +
  scale_y_continuous(
    breaks = scales::breaks_width(0.5),
    #limits = c(-0.7, 1.75)\
  ) +
  coord_flip() +
  scale_color_viridis_d(begin = 0.3, end = 0.7, direction = -1) +
  theme_classic() +
  xlab("") +
  ylab("Hedges' g") +
  theme(legend.position = "none") 

p2

ggplot2::ggsave(filename = "plots/baseline to postinduction effect sizes.pdf", 
                plot     = p2,
                device   = "pdf",
                width    = 6, 
                height   = 2, 
                units    = "in")

```

# Compare studies with pure negative controls and all three timepoints (baseline, postinduction, postintervention)

## Plot means

Intervals are 95% CIs calculated from the SEs, which were calculated from the N and SDs.

```{r fig.height=4, fig.width=5}

dat_negative_controls <- dat |>
  filter(included_no_instructions_condition == TRUE) 

p3 <-
  ggplot(dat_negative_controls, aes(timepoint, m, color = study, group = study)) +
  geom_line(alpha = 0.5,
            position = position_dodge(width = 0.2)) +
  geom_linerange(aes(ymin = m - se*1.96, ymax = m + se*1.96), position = position_dodge(width = 0.2)) +
  geom_point(position = position_dodge(width = 0.2)) +
  scale_color_viridis_d(option = "mako", begin = 0.3, end = 0.7,
                        name = "Study") +
  ylim(0,100) +
  theme_linedraw() +
  ylab("Anxiety VAS") +
  xlab("Time point") +
  theme(legend.position = c(.75, .85),
        legend.background = element_rect(fill='transparent'),
        legend.box.background = element_rect(fill='white'))

p3

ggplot2::ggsave(filename = "plots/negative controls.pdf", 
                plot     = p3,
                device   = "pdf",
                width    = 5, 
                height   = 4, 
                units    = "in")

```

## Table effect sizes

Positive values represent less anxiety.

```{r}

data_es_negative_controls <-
  bind_rows(
    dat_negative_controls |>
      pivot_wider(names_from = timepoint,
                  values_from = c(m, sd, n, se)) |>
      group_by(study) |>
      do(t_test_from_descriptives(m1 = .$m_Baseline, 
                                  m2 = .$m_Postinduction, 
                                  sd1 = .$sd_Baseline, 
                                  sd2 = .$sd_Postinduction, 
                                  n1 = .$n_Baseline, 
                                  n2 = .$n_Postinduction)) |>
      mutate(comparison = "Baseline vs postinduction"),
    
    dat_negative_controls |>
      pivot_wider(names_from = timepoint,
                  values_from = c(m, sd, n, se)) |>
      group_by(study) |>
      do(t_test_from_descriptives(m1 = .$m_Postinduction, 
                                  m2 = .$m_Postdelay, 
                                  sd1 = .$sd_Postinduction, 
                                  sd2 = .$sd_Postdelay, 
                                  n1 = .$n_Postinduction, 
                                  n2 = .$n_Postdelay)) |>
      mutate(comparison = "Postinduction vs postdelay"),
    
    dat_negative_controls |>
      pivot_wider(names_from = timepoint,
                  values_from = c(m, sd, n, se)) |>
      group_by(study) |>
      do(t_test_from_descriptives(m1 = .$m_Baseline, 
                                  m2 = .$m_Postdelay, 
                                  sd1 = .$sd_Baseline, 
                                  sd2 = .$sd_Postdelay, 
                                  n1 = .$n_Baseline, 
                                  n2 = .$n_Postdelay)) |>
      mutate(comparison = "Baseline vs postdelay") 
  ) |>
  select(study, comparison, hedges_g, lower = hedges_g_ci_lower, upper = hedges_g_ci_upper, 
         t, df, p) |>
  mutate(p = apa_p_value(p, digits = 5)) |>
  arrange(study) |>
  round_all_but_p_values()

data_es_negative_controls |>
  kable() |>
  kable_classic(full_width = FALSE)

write_csv(data_es_negative_controls, "tables/effect sizes negative controls.csv")

```

## Compare previous studies and Foody studies

```{r fig.height=3, fig.width=6}

dat_es_combined <- 
  bind_rows(
    data_es_induction |>
      mutate(outcome = "anxiety",
             hedges_g = hedges_g*-1, 
             lower = lower*-1, 
             upper = upper*-1),
    data_foodyetal2013,
    data_foodythesisexp10
  ) |>
  select(study, outcome, interval, hedges_g, lower, upper) |>
  mutate(study = fct_relevel(study, 
                             "Rachman et al. (1996)", 
                             "van den Hout et al. (2002)", 
                             "Zucker et al. (2002)", 
                             "Bocci & Gordon (2007)",
                             "Foody et al. (2013)",
                             "Foody (2013) thesis experiment 10"),
         interval = ifelse(is.na(interval), "Not applicable (SD reported)", interval))

# viridisLite::mako(n = 2, begin = 0.4, end = 0.6)
# viridisLite::viridis(n = 2, begin = 0.3, end = 0.7)

p_comparison <- 
  dat_es_combined |>
  filter(outcome == "anxiety") |>
  ggplot(aes(hedges_g, study, color = interval)) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_point(shape = "square", position = position_dodge2(width = 0.5)) +
  geom_linerangeh(aes(xmin = lower, xmax = upper), position = position_dodge2(width = 0.5)) +
  scale_x_continuous(
    breaks = scales::breaks_width(0.5),
    #limits = c(-0.7, 1.75)\
  ) +
  #coord_flip() +
  scale_color_manual(breaks = c("Assuming intervals are 95% CIs", "Assuming intervals are SEMs"),
                     values = c("#2A788EFF", "#22A884FF", "darkgrey"),
                     name = NULL, 
                     guide = guide_legend(reverse = TRUE)) +
  theme_linedraw() +
  ylab("") +
  xlab("Hedges' g") +
  theme(legend.position = c(.73, .83),
        legend.background = element_rect(fill='transparent',
                                         color = "black",
                                         size = 0.1),
        legend.box.background = element_rect(fill='white'),
        legend.text = element_text(size = 7),
        panel.grid.minor = element_blank())

p_comparison

ggplot2::ggsave(filename = "plots/baseline to postinduction effect sizes comparison with foody.pdf", 
                plot     = p_comparison,
                device   = "pdf",
                width    = 6, 
                height   = 3, 
                units    = "in")

```

# Session info

```{r}

sessionInfo()

```


